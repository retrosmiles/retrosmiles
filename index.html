<html>
<head>
	<meta charset="utf-8">
	<link rel="manifest" href="manifest.webmanifest">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<title>RetroSmiles</title>
	<script src="js/clipboard.min.js"></script>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/notify.js"></script>
	<link rel="stylesheet" href="css/main.css?v=3">
</head>
<body>
<div id="splash">RetroSmiles</div>
	<script>
	var d = new Date();
	var n = d.getDay().toString();
	if(localStorage.getItem('lastsplash')!=n)
		document.getElementById('splash').style.backgroundImage = "url('./QuickSmiles/0/"+ Math.floor(Math.random() * 100) +".gif')";
	else
		$('#splash').hide();

	var currentTab = '';
	var history_data = [];
	var _tmp_h  = JSON.parse(localStorage.getItem("history_data"));
	if(Array.isArray(_tmp_h)) 
		history_data = _tmp_h;

	if(!ClipboardJS.isSupported()) $.notify("Copy to clipboard is not supported for your browser!");
	var clipboard = new ClipboardJS('.btn', {
		text: function(trigger) {
			if(trigger.getAttribute('data-clipboard-text') == '' || trigger.getAttribute('data-clipboard-text') == null) {
				return '';
			}
			var tbbcode = trigger.getAttribute('data-clipboard-text');
			var tbbcode2 = tbbcode;
			if(!$("#bbcode").hasClass('active')) {
				tbbcode = tbbcode.replace("[img]","<img src='");
				tbbcode = tbbcode.replace("[/img]","'>");
				tbbcode = tbbcode.replace("[url=","<a href='");
				tbbcode = tbbcode.replace("[/url]","</a>");
				tbbcode = tbbcode.replace("]","'>");
			}
			
			if(currentTab != 'tab0-tab') {
						var _tmp_arr = [cleanUrl(tbbcode2) , cleanUrl(trigger.src)];
						if(not_in(history_data,_tmp_arr[0])) {
				//			console.log(_tmp_arr);
							history_data.push(_tmp_arr);
							if(history_data.length > 60) history_data.shift();
							localStorage.setItem("history_data", JSON.stringify(history_data));
					}
			}

			if(tbbcode2.toString().replace("[img]","").replace("[/img]","") != trigger.src && typeof trigger.src !== 'undefined' && trigger.src !== false) {
				trigger.src =  tbbcode2.toString().replace("[img]","").replace("[/img]","");
			}

				return tbbcode;
		}
	});
	clipboard.on('success', function(e) {
		$.notify("Copied to clipboard!", {
					autoHideDelay: 500
				});
		e.clearSelection();
	});
	clipboard.on('error', function(e) {
		$.notify("Error: Could not copy to clipboard!");
	});

	function cleanUrl(url) {
		return url.replace("[img]","").replace("https://retrosmiles.github.io/retrosmiles/QuickSmiles/","").replace("http://localhost/retrosmiles/QuickSmiles/","").replace("[/img]","")
	}
	
	function not_in(arr,val) {
		if(arr.length < 1) return true;
		
		for (var i = 0;i < history_data.length; i++) {
			if(arr[i][0] == val)
				return false;
		}
		
		return true;
	}

	function loadImages() {
		let imgs = $("img");
		for(let a=0;a<imgs.length;a++){
    		loadImage(imgs[a]);
		}

		function loadImage(elem){
		  let url = $(elem).attr("ref-src");

			if (typeof url !== 'undefined' && url !== false) {
				//console.log(url);
			  let newImg = new Image();
			  newImg.onload = function(){
			   		$(elem).attr("src", url);
				}
		  	newImg.src = url;
			}
		}
	}
	function loadTab2(e) {
		loadTab(e,'html');
	}

	function loadTabCSV(e,format) {
		currentTab = e;
		console.log('loading tab '+e);
		
		$('.cell').removeClass('selectedcell');
		$('#' + e).addClass('selectedcell');
		$('#dtext').html($('#' + e).html());
		$('#selText').html($('#' + e).html());
		if(e.toString() != 'tab999-tab' && e.toString() != 'tab998-tab') localStorage.setItem('lasttab', e.toString());
		var targ = '#maintab';
		$(targ).html('<p>Loading, please wait...</p>');
		$(targ).addClass('active');
		$(targ).addClass('show');
		$(targ).show();
		var loadurl = e.replace('-tab',(format=='html'?'.html':'.txt')) + '?' + Date.now();
		//console.log('loading '+loadurl);
			$.notify("loading...", {
				autoHideDelay: 1000
			});
			
			if(e == 'tab0-tab') {
				
				if(Array.isArray(history_data) && history_data.length > 0) {
					var _tmp_data = "";
					//console.log(history_data);
					for (var i = history_data.length - 1; i >= 0; i--) {
						_tmp_data+="\n"+history_data[i][0]+","+history_data[i][1];
					}
					$(targ).html(renderCSV(_tmp_data));
					loadImages();
				} else {
					$(targ).html("<p style='padding:1em'>no smiley clicked! <img src='./QuickSmiles/0/162.gif'></p>");
				}
				
			} else {
			
					try {
						$.get(loadurl, function(data) {
							if(format=='html')
								$(targ).html(data);
							else
								$(targ).html(renderCSV(data));
							loadImages();
						}).fail(function() {
							$.notify("error, try later.", {
								autoHideDelay: 1000
							});
						});
					} catch(e) {
						$.notify("error, try later.", {
							autoHideDelay: 1000
						});
					}

		}
		
		$(window).scrollTop(0);
	}

	function renderCSV(csv) {
			var rows = csv.split(/\r\n|\n/);
			var html = '', img = "", bbcode = "";
			if(Array.isArray(rows)) {
				for(var row=0;row<rows.length;row++) {
					var cols = rows[row].split(',');
					if(Array.isArray(cols)) {
						for(var i=0;i<cols.length;i++) {
							cols[i] = cols[i].replace('"','').trim().toString();
							switch (i) {
								case 0:
									var bbcode = cols[i].toString();
									break;

									case 1:
									var img = cols[i].toString();
									break;

								default:

							}
						}

						if(bbcode.indexOf('#') != 0) {
							bbcode = bbcode.toString().trim();
							img = img.toString().trim();
							if(bbcode != '' && img != '') { 
								html+='<div class="col-auto col-md-2"> <img class="btn" data-clipboard-text="[img]https://retrosmiles.github.io/retrosmiles/QuickSmiles/'+bbcode+'[/img]" src="css/placeholder.png" ref-src="QuickSmiles/'+img+'"></div>';
							}
						}

					}
				}

				html = '<div class="row">' + html + '</div>';
			}

			return html;
	}

	function loadTab(e,t) {
		return loadTabCSV(e,t);

		$('.cell').removeClass('selectedcell');
        $('#' + e).addClass('selectedcell');
		$('#dtext').html($('#' + e).html());
		$('#selText').html($('#' + e).html());
		if(e.toString() != 'tab999-tab' && e.toString() != 'tab998-tab') localStorage.setItem('lasttab', e.toString());
		var targ = '#maintab';
    $(targ).html('<p>Loading, please wait...</p>');
		$(targ).addClass('active');
		$(targ).addClass('show');
		$(targ).show();
		var loadurl = e.replace('-tab', '.html') + '?' + Date.now();
			$.notify("loading...", {
				autoHideDelay: 1000
			});
			try {
				$.get(loadurl, function(data) {
					$(targ).html(data);
					loadImages();
				}).fail(function() {
					$.notify("error, try later.", {
						autoHideDelay: 1000
					});
				});
			} catch(e) {
				$.notify("error, try later.", {
					autoHideDelay: 1000
				});
			}
		$(window).scrollTop(0);
	}

	function loadTabs() {
		var deftab = 'tab2-tab';
		var targ = '.menuscroller';
		var loadurl = 'buttons.html' + '?' + Date.now();
		if($(targ).html().indexOf(' < a class ') <= 0) {
				try {
					$.get(loadurl, function(data) {
						$(targ).html(data);
						if(localStorage["lasttab"]) {
							deftab = localStorage.getItem('lasttab');
						}
						loadTab(deftab);

						var d = new Date();
					  var n = d.getDay().toString();
						if(localStorage.getItem('lastsplash')!=n)
							setTimeout(function(){ $('#splash').fadeOut(); }, 2500);
						else
							$('#splash').fadeOut();
						localStorage.setItem('lastsplash', n);

					}).fail(function() {
						$.notify("error, try later.", {
							autoHideDelay: 1000
						});
					});
				} catch(e) {
					$.notify("error, try later.", {
						autoHideDelay: 1000
					});
				}
			}
		}
		$(function() {
			$('#myTabContent').css({
				top: ($('#header').offset().top + $('#header').height() + $('.tabl').offset().top + $('.tabl').height() + 5) + 'px'
			});
			loadTabs();
		});
	</script>
	<div id="header">
		<div class="logo row">
			<div class="col-8 col-md-8 col-sm-8">
				RetroSmiles<span class="btn" style="cursor:pointer" data-clipboard-text="[url=https://retrosmiles.github.io/retrosmiles]Visit RetroSmiles[/url]"><img src="copy.png"/></span>
			</div>
			<div class="col-4 col-md-4 col-sm-4 text-right">
				<button type="button" id="bbcode" class="btn btn-sm btn-toggle active" data-toggle="button" aria-pressed="true" autocomplete="off">
        <div class="handle"></div>
			</div>
		</div>
		<div class="row tabl">
			<div class="col-12">
				<div class="horizontal-scrollable">
					<div class="menuscroller">
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="tab-content" id="myTabContent">
		<div class="tab-pane fade" id="maintab" role="tabpanel" aria-labelledby="maintab-tab">
			<p>Loading...</p>
		</div>
	</div>
</body>
</html>
